<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryoPCM-Lab Sample Interface</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/interface.css">
</head>
<body>

<header>
    <h1>CryoPCM-Lab</h1>
    <p class="tagline">
        Sample interface for exploring the PCM database
    </p>
</header>

<main class="interface-layout">
    <!-- Left zone: filters / inputs -->
    <section class="zone-left">
        <h2>Filter Materials</h2>
        <form class="pcm-filters" id="pcm-filters-form">
            <div class="form-row">
                <label for="temperature-range"> Application temperature range (K)</label>
                <div>
                    <input type="number" id="tmin" name="tmin" placeholder="Tmin : 100 K">
                    <span>to</span>
                    <input type="number" id="tmax" name="tmax" placeholder="Tmax :250 K">
                </div>
            </div>
            <div class="form-actions">
                <button type="submit" class="button">Apply filters</button>
                <button type="reset" class="button secondary">Reset</button>
            </div>
        </form>

        <div id="search-status" class="search-status">
            No search performed yet.
        </div>
        <div class="search-results">
            <label for="result-select">Search results:</label>
            <select id="result-select" disabled>
                <option value="">No results yet</option>
            </select>
        </div>
    </section>

    <!-- Right zone: split vertically into results (top) and graph (bottom) -->
    <section class="zone-right">
        <!-- Top-right: selected PCM details and property dropdown -->
        <div class="zone-top">
            <div class="zone-top-header">
                <div>
                    <h2>Selected PCM : <span id="selected-pcm-name" class="selected-pcm-name"></span></h2> 
                </div>
            </div>
            <div class="pcm-cards">
                <div class="pcm-card">
                    <h3>Melting point temperature (K)</h3>
                    <p id="prop-melting-point">–</p>
                </div>
                <div class="pcm-card">
                    <h3>Boiling point temperature (K)</h3>
                    <p id="prop-boiling-point">–</p>
                </div>
                <div class="pcm-card">
                    <h3>Latent heat (kJ/kg)</h3>
                    <p id="prop-latent-heat">–</p>
                </div>
                <div class="pcm-card">
                    <h3>Flash point temperature (K)</h3>
                    <p id="prop-flash-point">–</p>
                </div>
                <div class="pcm-card">
                    <h3>Safety classification</h3>
                    <p id="prop-safety-rating">–</p>
                </div>
                <div class="pcm-card">
                    <h3>Cost (per litre)</h3>
                    <p id="prop-cost">–</p>
                </div>
            </div>
            <br>
            <br>
            <label>
                Select property to plot with temperature:
                <select id="property-select">
                    <option value="solid-specific-heat">Solid phase specific heat capacity (kJ/kg)</option>
                    <option value="liquid-specific-heat">Liquid phase specific heat capacity (kJ/kg)</option>
                    <option value="solid-thermal-conductivity">Solid phase thermal conductivity (W/mK)</option>
                    <option value="liquid-thermal-conductivity">Liquid phase thermal conductivity (W/mK)</option>
                    <option value="solid-density">Solid phase density (kg/m³)</option>
                    <option value="liquid-density">Liquid phase density (kg/m³)</option>
                    <option value="solid-thermal-diffusivity">Solid phase thermal diffusivity (m²/s)</option>
                    <option value="liquid-thermal-diffusivity">Liquid phase thermal diffusivity (m²/s)</option>
                </select>
            </label>

        </div>

        <!-- Bottom-right: Plotly line plot of selected property -->
        <div class="zone-bottom">
            <h2>Property plot</h2>
            <p>
                Line plot of the selected property as a function of temperature (Plotly.js).
            </p>
            <div class="chart-area">
                <div id="property-chart"></div>
            </div>
        </div>
    </section>
</main>

<footer>
    <p>
        &copy; <span id="year"></span> CryoPCM-Lab (sample interface).
    </p>
</footer>

<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="scripts/plot-visualization.js"></script>

<script>
    // Set current year in footer
    document.getElementById('year').textContent = new Date().getFullYear();

    let pcms = [];
    let lastFiltered = [];

    const numericPcmFields = ['tmin', 'tmax', 'latentHeat', 'meltingPointK', 'boilingPointK', 'flashPointK', 'cost'];

    function parsePcmsCsv(csvText) {
        const lines = csvText.trim().split(/\r?\n/);
        if (lines.length < 2) return [];
        const headers = lines[0].split(',').map(h => h.trim());
        const rows = [];
        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',').map(v => v.trim());
            const obj = {};
            headers.forEach((h, j) => {
                obj[h] = numericPcmFields.indexOf(h) >= 0 ? parseFloat(values[j]) : (values[j] || '');
            });
            rows.push(obj);
        }
        return rows;
    }

    function loadPcms() {
        return fetch('rawdata/pcms.csv')
            .then(response => response.text())
            .then(text => {
                pcms = parsePcmsCsv(text);
                lastFiltered = pcms.slice();
            })
            .catch(() => {
                pcms = [];
                lastFiltered = [];
            });
    }

    let chartData = null;

    function loadChartData() {
        return fetch('rawdata/property_series.json')
            .then(response => response.json())
            .then(data => { chartData = data; })
            .catch(() => { chartData = {}; });
    }

    function getSelectedPropertyKey() {
        return document.getElementById('property-select').value;
    }

    function updateSearchStatus(message) {
        const statusEl = document.getElementById('search-status');
        if (statusEl) {
            statusEl.textContent = message;
        }
    }

    function populateResultsDropdown(filtered) {
        const select = document.getElementById('result-select');
        select.innerHTML = '';

        if (!filtered || filtered.length === 0) {
            select.disabled = true;
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'No results';
            select.appendChild(opt);
            return;
        }

        select.disabled = false;

        filtered.forEach(pcm => {
            const opt = document.createElement('option');
            opt.value = pcm.id;
            opt.textContent = `${pcm.id} — ${pcm.name}`;
            select.appendChild(opt);
        });
    }

    function findPcmById(id) {
        return lastFiltered.find(pcm => pcm.id === id) || null;
    }

    function updateSelectedPcmDetails(pcm) {
        const nameEl = document.getElementById('selected-pcm-name');
        const meltingEl = document.getElementById('prop-melting-point');
        const boilingEl = document.getElementById('prop-boiling-point');
        const latentEl = document.getElementById('prop-latent-heat');
        const flashEl = document.getElementById('prop-flash-point');
        const safetyEl = document.getElementById('prop-safety-rating');
        const costEl = document.getElementById('prop-cost');

        if (!pcm) {
            if (nameEl) nameEl.textContent = 'No PCM selected.';
            if (meltingEl) meltingEl.textContent = '–';
            if (boilingEl) boilingEl.textContent = '–';
            if (latentEl) latentEl.textContent = '–';
            if (flashEl) flashEl.textContent = '–';
            if (safetyEl) safetyEl.textContent = '–';
            if (costEl) costEl.textContent = '–';
            return;
        }

        if (nameEl) {
            nameEl.textContent = `${pcm.id} — ${pcm.name}`;
        }
        if (meltingEl) {
            meltingEl.textContent = `${pcm.meltingPointK.toFixed(1)} K`;
        }
        if (boilingEl) {
            boilingEl.textContent = `${pcm.boilingPointK.toFixed(1)} K`;
        }
        if (latentEl) {
            latentEl.textContent = `${pcm.latentHeat.toFixed(1)} kJ/kg`;
        }
        if (flashEl) {
            flashEl.textContent = `${pcm.flashPointK.toFixed(1)} K`;
        }
        if (safetyEl) {
            safetyEl.textContent = pcm.safetyRating;
        }
        if (costEl) {
            costEl.textContent = `${pcm.cost.toFixed(2)} (relative units)`;
        }
    }

    function drawChart(propertyKey) {
        const selectedIdEl = document.getElementById('result-select');
        const selectedPcmId = selectedIdEl ? selectedIdEl.value : null;
        if (typeof drawPropertyChart === 'function') {
            drawPropertyChart('property-chart', propertyKey, chartData, selectedPcmId);
        }
    }

    function applyFilters() {
        const tmin = parseFloat(document.getElementById('tmin').value);
        const tmax = parseFloat(document.getElementById('tmax').value);
        const rangeEntered = !isNaN(tmin) && !isNaN(tmax) && tmin <= tmax;

        let filtered = pcms.filter(pcm => {
            // Temperature range filter: melting point within [tmin, tmax], boiling point above tmax
            if (rangeEntered) {
                const melting = Number(pcm.meltingPointK);
                const boiling = Number(pcm.boilingPointK);
                if (isNaN(melting) || melting < tmin || melting > tmax) {
                    return false;
                }
                if (isNaN(boiling) || boiling <= tmax) {
                    return false;
                }
            }
            return true;
        });

        lastFiltered = filtered;

        if (filtered.length === 0) {
            updateSearchStatus('Search completed: no matching PCMs.');
            populateResultsDropdown([]);
            updateSelectedPcmDetails(null);
        } else {
            updateSearchStatus(`Search completed: ${filtered.length} PCM(s) found.`);
            populateResultsDropdown(filtered);
            // Default to the first result
            updateSelectedPcmDetails(filtered[0]);
            document.getElementById('result-select').value = filtered[0].id;
        }

        const propertyKey = getSelectedPropertyKey();
        drawChart(propertyKey);
    }

    // Event wiring
    document.getElementById('pcm-filters-form').addEventListener('submit', function (evt) {
        evt.preventDefault();
        applyFilters();
    });

    document.getElementById('pcm-filters-form').addEventListener('reset', function () {
        // Allow the reset to clear inputs, then re-apply with all data
        setTimeout(() => {
            lastFiltered = pcms.slice();
            updateSearchStatus('Filters reset: showing all PCMs.');
            populateResultsDropdown(lastFiltered);
            if (lastFiltered.length > 0) {
                updateSelectedPcmDetails(lastFiltered[0]);
                document.getElementById('result-select').value = lastFiltered[0].id;
            } else {
                updateSelectedPcmDetails(null);
            }
            const propertyKey = getSelectedPropertyKey();
            drawChart(propertyKey);
        }, 0);
    });

    document.getElementById('property-select').addEventListener('change', function () {
        const propertyKey = getSelectedPropertyKey();
        drawChart(propertyKey);
    });

    document.getElementById('result-select').addEventListener('change', function () {
        const id = this.value;
        const pcm = findPcmById(id);
        updateSelectedPcmDetails(pcm);
        drawChart(getSelectedPropertyKey());
    });

    // Load PCM data (CSV) and chart data (JSON), then run initial render
    Promise.all([loadPcms(), loadChartData()]).then(function () {
        updateSearchStatus(lastFiltered.length > 0 ? 'Showing all PCMs (no filters applied yet).' : 'No PCM data loaded. Check rawdata/pcms.csv.');
        populateResultsDropdown(lastFiltered);
        if (lastFiltered.length > 0) {
            updateSelectedPcmDetails(lastFiltered[0]);
            document.getElementById('result-select').value = lastFiltered[0].id;
        } else {
            updateSelectedPcmDetails(null);
        }
        drawChart(getSelectedPropertyKey());
    });
</script>

</body>
</html>

